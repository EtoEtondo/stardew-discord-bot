name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

env:
  IMAGE_NAME: stardew-discord-bot

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Install uv
        run: pip install --no-cache-dir uv
      - name: Sync dependencies
        run: uv sync --dev
      - name: Ruff lint
        run: uv run ruff check .
      - name: Ruff format check
        run: uv run ruff format --check .
      - name: Mypy
        run: uv run mypy .
      - name: Pytest
        run: uv run pytest

  docker_build_check:
    runs-on: ubuntu-latest
    needs: quality
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t release-check .

  publish_image:
    runs-on: ubuntu-latest
    needs: docker_build_check
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
      - name: Build and push image
        env:
          OWNER_LOWER: "${{ github.repository_owner }}"
        run: |
          IMAGE="ghcr.io/${OWNER_LOWER,,}/${IMAGE_NAME}"
          TAG="${GITHUB_REF_NAME}"
          docker build -t "${IMAGE}:${TAG}" -t "${IMAGE}:latest" .
          docker push "${IMAGE}:${TAG}"
          docker push "${IMAGE}:latest"

  deploy:
    runs-on: ubuntu-latest
    needs: publish_image
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
    steps:
      - name: Deploy to Oracle VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            IMAGE="ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}"
            cd /opt/stardew-bot
            docker compose pull
            DEPLOY_VERSION="${GITHUB_REF_NAME}" IMAGE="${IMAGE}" docker compose up -d
